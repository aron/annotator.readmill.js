/*  Readmill Annotator Plugin - v0.2.1
 *  Copyright 2011, Aron Carroll
 *  Released under the MIT license
 *  More Information: http://github.com/aron/readmill.annotator.js
 */
((function(){var a,b,c,d,e,f=function(a,b){return function(){return a.apply(b,arguments)}},g=Object.prototype.hasOwnProperty,h=function(a,b){function d(){this.constructor=a}for(var c in b)g.call(b,c)&&(a[c]=b[c]);return d.prototype=b.prototype,a.prototype=new d,a.__super__=b.prototype,a},i=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};Annotator.Readmill=c=function(a){function c(a,b){this.disconnect=f(this.disconnect,this),this.connect=f(this.connect,this),this.updatePrivacy=f(this.updatePrivacy,this),this.endReading=f(this.endReading,this),this.lookupReading=f(this.lookupReading,this);var d,e,h,i;c.__super__.constructor.apply(this,arguments),d=function(){var a,c,d,f;d=["book","clientId","callbackUrl"],f=[];for(a=0,c=d.length;a<c;a++)e=d[a],b[e]||f.push(e);return f}();if(d.length)throw new Error('options "'+d.join('", ')+'" are required by the Readmill plugin. eg:\n\njQuery("#content").annotator()\n.annotator("addPlugin", "Readmill", {\n  book: {id: "52"}, /* Or use a title & author. */\n  book: {title: "Brighton Rock", author: "Graham Greene"}\n  clientId: "12345",\n  callbackUrl: "http://example.com/callback.html"\n});');this.user=null,this.book=this.options.book,this.view=new c.View,this.auth=new c.Auth(this.options),this.store=new c.Store,this.client=new c.Client(this.options),c.utils.proxyHandlers(this);for(e in this){if(!g.call(this,e))continue;i=this[e],e.indexOf("Error")>-1&&(this[e]=this._createUnauthorizedHandler(i))}h=b.accessToken||this.store.get("access-token"),h&&this.connected(h,{silent:!0}),this.unsaved=[]}var b;return h(c,a),b=Annotator.$,c.prototype.events={annotationCreated:"_onAnnotationCreated",annotationUpdated:"_onAnnotationUpdated",annotationDeleted:"_onAnnotationDeleted"},c.prototype.options={getPage:function(){return window.location.href.split("?").shift()}},c.prototype.pluginInit=function(){var a=this;return this.view.on("reading",this.lookupReading),this.view.on("finish",this.endReading),this.view.on("privacy",this.updatePrivacy),this.view.on("connect",this.connect),this.view.on("disconnect",this.disconnect),b("body").append(this.view.render()),this.client.isAuthorized()?this.lookupReading().done(function(){return a.view.reading({silent:!0})}):this.lookupBook()},c.prototype.lookupBook=function(){var a=this;return this.book.promise?this.book.promise:(this.book.promise=this.book.id?this.client.getBook(this.book.id):this.client.matchBook(this.book),this.book.promise.then(this._onBookSuccess,this._onBookError).done(function(){return a.view.updateBook(a.book)}))},c.prototype.lookupReading=function(){var a=this;return this.lookupBook().done(function(){var b;return b=a.client.createReadingForBook(a.book.id,{state:c.Client.READING_STATE_OPEN,"private":a.view.isPrivate()}),b.then(a._onCreateReadingSuccess,a._onCreateReadingError)})},c.prototype.endReading=function(){if(this.book.reading)return this.client.updateReading(this.book.reading.uri,{state:c.Client.READING_STATE_FINISHED}),this.removeAnnotations(),delete this.book.reading},c.prototype.updatePrivacy=function(){var a,b;a=this.view.isPrivate();if(this.book.reading&&this.book.reading.private!==a)return this.book.reading.private=a,b=this.client.updateReading(this.book.reading.uri,{"private":a}),b.fail(this._onUpdatePrivacyError)},c.prototype.connect=function(){return this.auth.connect().then(this._onConnectSuccess,this._onConnectError)},c.prototype.connected=function(a,b){var c=this;b==null&&(b={}),this.client.authorize(a),this.client.me().then(this._onMeSuccess,this._onMeError).done(function(){return c.view.login(c.user)}),this.store.set("access-token",a,b.expires);if((b!=null?b.silent:void 0)!==!0)return Annotator.showNotification("Successfully connected to Readmill")},c.prototype.unauthorized=function(){var a,c,d,e=this;return a="Not connected to Readmill, click here to connect",Annotator.showNotification(a),this.disconnect({removeAnnotations:!1}),c=b(".annotator-notice").one("click.readmill-auth",function(){return e.connect()}),d=function(){return c.unbind(".readmill-auth")},setTimeout(d,5e3)},c.prototype.disconnect=function(a){a==null&&(a={}),this.client.deauthorize(),this.store.remove("access-token");if(a.removeAnnotations!==!1)return this.removeAnnotations()},c.prototype.error=function(a){return Annotator.showNotification(a,Annotator.Notification.ERROR)},c.prototype.removeAnnotations=function(){return this.element.find(".annotator-hl").each(function(){return b(this).replaceWith(this.childNodes)})},c.prototype._createUnauthorizedHandler=function(a){var b=this;return function(c){var d;return d=c&&(c.status===401||c.status===0),d?b.unauthorized():a.apply(b,arguments)}},c.prototype._onConnectSuccess=function(a){return this.connected(a.access_token,a)},c.prototype._onConnectError=function(a){return this.error(a)},c.prototype._onMeSuccess=function(a){return this.user=a},c.prototype._onMeError=function(){return this.error("Unable to fetch user info from Readmill")},c.prototype._onBookSuccess=function(a){return b.extend(this.book,a)},c.prototype._onBookError=function(){return this.error("Unable to fetch book info from Readmill")},c.prototype._onCreateReadingSuccess=function(a,b,c){var d,e;return d=a.location,d?(e=this.client.request({url:d}),e.then(this._onGetReadingSuccess,this._onGetReadingError)):this._onGetReadingError()},c.prototype._onCreateReadingError=function(a){var b;return a.status===409?(b=JSON.parse(a.responseText),this._onCreateReadingSuccess(b,"success",a)):this.error("Unable to create a reading for this book")},c.prototype._onUpdatePrivacyError=function(a){return this.error("Unable to update the privacy state for this book")},c.prototype._onGetReadingSuccess=function(a){var b;return this.book.reading=a,this.view.updateBook(this.book),b=this.client.getHighlights(a.highlights),b.then(this._onGetHighlightsSuccess,this._onGetHighlightsError)},c.prototype._onGetReadingError=function(){return this.error("Unable to create a reading for this book")},c.prototype._onGetHighlightsSuccess=function(a){var d,e=this;return d=b.map(a,function(a){return c.utils.annotationFromHighlight(a,e.client)}),d=b.grep(d,function(a){return a.state()!=="rejected"}),b.when.apply(b,d).done(function(){var a;return a=b.makeArray(arguments),e.annotator.loadAnnotations(a)})},c.prototype._onGetHighlightsError=function(){return this.error("Unable to fetch highlights for reading")},c.prototype._onCreateHighlight=function(a,b){var c=this;return this.client.request({url:b.location}).done(function(b){a.id=b.id,a.highlightUrl=b.uri,a.commentsUrl=b.comments;if(a.text)return c._onAnnotationUpdated(a)})},c.prototype._onBeforeAnnotationCreated=function(a){return a.page=this.options.getPage()},c.prototype._onAnnotationCreated=function(a){var d,e,f,g,h=this;if(this.client.isAuthorized()&&this.book.id&&((g=this.book.reading)!=null?g.highlights:void 0))return f=this.book.reading.highlights,d=c.utils.highlightFromAnnotation(a),e=this.client.createHighlight(f,d),e.done(b.proxy(this,"_onCreateHighlight",a)),e.fail(this._onAnnotationCreatedError);this.unsaved.push(a),this.client.isAuthorized()||this.unauthorized();if(!this.book.id)return this.lookupBook().done(function(){return h._onAnnotationCreated(a)})},c.prototype._onAnnotationCreatedError=function(){return this.error("Unable to save annotation to Readmill")},c.prototype._onAnnotationUpdated=function(a){var b,d,e=this;b=c.utils.commentFromAnnotation(a),a.commentUrl?d=this.client.updateComment(a.commentUrl,b):a.commentsUrl&&(d=this.client.createComment(a.commentsUrl,b),d.done(function(b){return a.commentUrl=b.location}));if(d)return d.fail(this._onAnnotationUpdatedError)},c.prototype._onAnnotationUpdatedError=function(){return this.error("Unable to update annotation in Readmill")},c.prototype._onAnnotationDeleted=function(a){var b;if(a.highlightUrl)return b=this.client.deleteHighlight(a.highlightUrl),b.fail(this._onAnnotationDeletedError)},c.prototype._onAnnotationDeletedError=function(){return this.error("Unable to delete annotation on Readmill")},c}(Annotator.Plugin),Annotator.Class=Annotator.__super__.constructor,Annotator.Plugin.Readmill=Annotator.Readmill,Annotator.Readmill.utils=function(){var a;return a=Annotator.$,{proxyHandlers:function(b,c){var d,e;c==null&&(c="_on");for(d in b)e=b[d],d.indexOf(c)===0&&typeof e=="function"&&(b[d]=a.proxy(b,d));return b},serializeQueryString:function(a,b,c){var d,e,f;return b==null&&(b="&"),c==null&&(c="="),d=window.encodeURIComponent,function(){var b;b=[];for(e in a){if(!g.call(a,e))continue;f=a[e],b.push(""+d(e)+c+d(f))}return b}().join(b)},parseQueryString:function(a,b,c){var d,e,f,g,h,i,j,k,l;b==null&&(b="&"),c==null&&(c="="),f={},d=window.decodeURIComponent,k=a.split(b);for(i=0,j=k.length;i<j;i++)g=k[i],l=g.split(c),e=l[0],h=l[1],f[d(e)]=d(h);return f},preText:function(b){var c;return c=function(){var a;a=[];while(b=b.previousSibling)a.push(b);return a}(),a(c.reverse()).text()},postText:function(b){var c;return c=function(){var a;a=[];while(b=b.nextSibling)a.push(b);return a}(),a(c).text()},locatorsFromAnnotation:function(a){var b,c,d;return b=a.highlights,d=this.preText(b[0]),c=this.postText(b[b.length-1]),{pre:d,mid:a.quote,post:c,xpath:a.ranges[0],file_id:a.page}},highlightFromAnnotation:function(a){var b;return b=this.locatorsFromAnnotation(a),{id:a.id,content:a.quote,highlighted_at:void 0,locators:b}},commentFromAnnotation:function(a){return{content:a.text}},annotationFromHighlight:function(b,c){var d,e,f;return b.locators.xpath&&(f=function(){try{return{ranges:[b.locators.xpath]}}catch(a){return null}}()),f||(f=function(){try{return{ranges:JSON.parse(b.pre)}}catch(a){return null}}()),e=new a.Deferred,f?(d={id:b.id,page:b.locators.file_id||f.page,quote:b.content,text:"",ranges:f.ranges,highlightUrl:b.uri,commentUrl:"",commentsUrl:b.comments},c.request({url:b.comments}).fail(e.reject).done(function(a){return a.length&&(d.text=a[0].content,d.commentUrl=a[0].uri),e.resolve(d)})):e.reject(),e.promise()}}}(),Annotator.Readmill.Auth=a=function(){function c(a){this.clientId=a.clientId,this.callbackUrl=a.callbackUrl,this.authEndpoint=a.authEndpoint;if(!this.clientId)throw new Error('"clientId" option is required by Readmill.Auth');if(!this.callbackUrl)throw new Error('"callbackUrl" option is required by Readmill.Auth');this.authEndpoint||(this.authEndpoint=c.AUTH_ENDPOINT)}var a,b;return b=Annotator.Readmill.utils,a=Annotator.$,c.AUTH_ENDPOINT="https://readmill.com/oauth/authorize",c.uuid=function(){return c.uuid.counter||(c.uuid.counter=0),"state-"+(c.uuid.counter+=1)},c.prototype.connect=function(){var d,e,f;return d=new a.Deferred,d.id=c.uuid(),e={response_type:"code",client_id:this.clientId,redirect_uri:this.callbackUrl,state:d.id},f=b.serializeQueryString(e),c.callback=a.proxy(this.callback,this,d),this.popup=this.openWindow(""+this.authEndpoint+"?"+f),d.promise()},c.prototype.callback=function(a){var c,d,e;return c=this.popup.location.hash.slice(1),d=e=b.parseQueryString(c),this.popup.close(),d.access_token?a.resolve(d):a.reject(d.error)},c.prototype.openWindow=function(a,c,d){var e,f,g,h;return c==null&&(c=725),d==null&&(d=575),e=window.screenX+(window.outerWidth-c)/2,h=window.screenY+(window.outerHeight-d)/2,g={toolbar:!1,location:1,scrollbars:!0,top:h,left:e,width:c,height:d},f=b.serializeQueryString(g,","),window.open(a,"readmill-connect",f)},c}(),Annotator.Readmill.Client=b=function(){function b(a){a==null&&(a={}),this.clientId=a.clientId,this.accessToken=a.accessToken,this.apiEndpoint=a.apiEndpoint;if(!this.clientId)throw new Error("test");this.apiEndpoint||(this.apiEndpoint=b.API_ENDPOINT)}var a;return a=Annotator.$,b.API_ENDPOINT="https://api.readmill.com",b.READING_STATE_INTERESTING=1,b.READING_STATE_OPEN=2,b.READING_STATE_FINISHED=3,b.READING_STATE_ABANDONED=4,b.prototype.me=function(){return this.request({url:"/me",type:"GET"})},b.prototype.getBook=function(a){return this.request({url:"/books/"+a,type:"GET"})},b.prototype.matchBook=function(a){return this.request({url:"/books/match",type:"GET",data:{q:a}})},b.prototype.createBook=function(a){return this.request({url:"/books",type:"POST",data:{book:a}})},b.prototype.createReadingForBook=function(a,b){return b==null&&(b={}),b.private&&(b.private=String(b.private)),this.request({type:"POST",url:"/books/"+a+"/readings",data:{reading:b}})},b.prototype.updateReading=function(a,b){return b==null&&(b={}),b.private&&(b.private=String(b.private)),this.request({type:"PUT",url:a,data:{reading:b}})},b.prototype.getHighlights=function(a){return this.request({url:a,type:"GET"})},b.prototype.getHighlight=function(a){return this.request({url:a,type:"GET"})},b.prototype.createHighlight=function(a,b,c){return this.request({type:"POST",url:a,data:{highlight:b,comment:c}})},b.prototype.deleteHighlight=function(a){return this.request({type:"DELETE",url:a})},b.prototype.createComment=function(a,b){return this.request({type:"POST",url:a,data:{comment:b}})},b.prototype.updateComment=function(a,b){return this.request({type:"PUT",url:a,data:{comment:b}})},b.prototype.request=function(b){var c,d,e=this;return b==null&&(b={}),d=null,b.type||(b.type="GET"),b.url.indexOf("http")!==0&&(b.url=""+this.apiEndpoint+b.url),b.type.toUpperCase()in{POST:"POST",PUT:"PUT",DELETE:"DELETE"}?(b.url=""+b.url+"?&client_id="+this.clientId,b.data&&(b.data=JSON.stringify(b.data)),b.dataType="json",b.contentType="application/json"):b.data=a.extend({client_id:this.clientId},b.data||{}),b.dataFilter=a.trim,b.beforeSend=function(a){a.setRequestHeader("X-Response","Body"),a.setRequestHeader("Accept","application/json");if(e.accessToken)return a.setRequestHeader("Authorization","OAuth "+e.accessToken)},b.xhr=function(){return d=a.ajaxSettings.xhr()},c=a.ajax(b),c.xhr=d,c.getResponseHeader=function(a){return d.getResponseHeader(a)},c},b.prototype.authorize=function(a){return this.accessToken=a,this},b.prototype.deauthorize=function(){return this.accessToken=null,this},b.prototype.isAuthorized=function(){return!!this.accessToken},b}(),Annotator.Readmill.Store=d=function(a){function b(){b.__super__.constructor.apply(this,arguments)}return h(b,a),b.KEY_PREFIX="annotator.readmill/",b.CACHE_DELIMITER="--cache--",b.localStorage=window.localStorage,b.isSupported=function(){try{return i.call(window,"localStorage")>=0&&window.localStorage!==null}catch(a){return!1}},b.now=function(){return(new Date).getTime()},b.prototype.get=function(a){var c;return c=b.localStorage.getItem(this.prefixed(a)),c&&(c=this.checkCache(c),c||this.remove(a)),JSON.parse(c)},b.prototype.set=function(a,c,d){c=JSON.stringify(c),d&&(c=b.now()+d+b.CACHE_DELIMITER+c);try{b.localStorage.setItem(this.prefixed(a),c)}catch(e){this.publish("error",[e,this])}return this},b.prototype.remove=function(a){return b.localStorage.removeItem(this.prefixed(a)),this},b.prototype.prefixed=function(a){return b.KEY_PREFIX+a},b.prototype.checkCache=function(a){var c;return a.indexOf(b.CACHE_DELIMITER)>-1&&(c=a.split(b.CACHE_DELIMITER),a=b.now()>c.shift()?null:c.join(b.CACHE_DELIMITER)),a},b}(Annotator.Class),Annotator.Readmill.View=e=function(a){function c(){this._onCheckboxChange=f(this._onCheckboxChange,this),this._onLogoutClick=f(this._onLogoutClick,this),this._onConnectClick=f(this._onConnectClick,this),c.__super__.constructor.call(this,b('<div class="annotator-readmill"/>').html(this.template))}var b;return h(c,a),b=Annotator.$,c.prototype.events={".annotator-readmill-connect a click":"_onConnectClick",".annotator-readmill-logout a click":"_onLogoutClick","input[type=checkbox] change":"_onCheckboxChange"},c.prototype.states={CONNECT:"connect",START_READING:"start",NOW_READING:"reading"},c.prototype.classes={checked:"annotator-readmill-checked",reading:"annotator-readmill-reading",loggedIn:"annotator-readmill-logged-in"},c.prototype.template='<a class="annotator-readmill-avatar" target="_blank">\n  <img />\n</a>\n<div class="annotator-readmill-reading">\n  <a class="annotator-readmill-book" target="_blank"></a>\n  <input type="checkbox" id="annotator-readmill-private-reading" />\n  <label for="annotator-readmill-private-reading">Private Reading</label>\n</div>\n<div class="annotator-readmill-connect">\n  <a href="#connect">Connect with Readmill</a>\n</div>\n<div class="annotator-readmill-logout">\n  <a href="#">Log Out</a>\n</div>',c.prototype.isPrivate=function(){return this.element.find("input[type=checkbox]")[0].checked},c.prototype.connect=function(a){return a==null&&(a={}),a.silent||this.publish("connect",[this]),this},c.prototype.disconnect=function(a){return a==null&&(a={}),a.silent||this.publish("disconnect",[this]),this},c.prototype.login=function(a,b){return b==null&&(b={}),a&&this.updateUser(a),this.updateState(this.states.START_READING),this.element.addClass(this.classes.loggedIn),b.silent||this.publish("login",[this]),this},c.prototype.reading=function(a){return a==null&&(a={}),this.updateState(this.states.NOW_READING),a.silent||this.publish("reading",[this]),this},c.prototype.finish=function(a){return a==null&&(a={}),a.silent||this.publish("finish",[this]),this.login(),this},c.prototype.logout=function(a){return a==null&&(a={}),this.element.removeClass(this.classes.loggedIn).html(this.template),this.user=null,this.updateBook(),a.silent||this.publish("logout",[this]),this},c.prototype.updateUser=function(a){var b;return this.user=a!=null?a:this.user,this.user&&(b={href:this.user.permalink_url,title:""+this.user.fullname+" ("+this.user.username+")"},this.element.find(".annotator-readmill-avatar").attr(b).find("img").attr("src",this.user.avatar_url)),this},c.prototype.updateBook=function(a){var b,c;return this.book=a!=null?a:this.book,c="Loading book…",b=this.element.find(".annotator-readmill-book"),this.book&&(this.book.title&&(c=this.book.title),this.book.reading&&(this.updatePrivate(this.book.reading.private),b.attr("href",this.book.reading.permalink_url))),b.escape(c),this},c.prototype.updateState=function(a){var b;return b={},b[this.states.CONNECT]="Connect With Readmill&hellip;",b[this.states.START_READING]="Begin Reading&hellip;",b[this.states.NOW_READING]="Now Reading&hellip;",this.element.find(".annotator-readmill-connect a").html(b[a]).attr("href","#"+a),this},c.prototype.updatePrivate=function(a,b){a==null&&(a=!1),b==null&&(b={});if(a!==this.isPrivate()||b.force===!0)this.element.find("label").toggleClass(this.classes.checked,a),this.element.find("input[type=checkbox]")[0].checked=a,this.publish("privacy",[a,this]);return this},c.prototype.render=function(){return this.updateBook(),this.updateUser(),this.element},c.prototype._onConnectClick=function(a){a.preventDefault();switch(a.target.hash.slice(1)){case this.states.CONNECT:return this.connect();case this.states.START_READING:return this.reading()}},c.prototype._onLogoutClick=function(a){return a.preventDefault(),this.disconnect(),this.logout()},c.prototype._onCheckboxChange=function(a){return this.updatePrivate(a.target.checked,{force:!0})},c}(Annotator.Class)})).call(this);
